## kali&#46;hardening&#46;sh
>**You are here: [░▒▓ pentesting-cookbook ▓▒░](../README.md)  &rarr;  [run.kali.x86.sh](run.kali.md)   &rarr;  [kali.hardening.sh](kali.hardening.md)**

### Update & harden SSH Daemon Configuration
```bash
cat > /etc/ssh/sshd_config << EOF
AllowTcpForwarding no
ChallengeResponseAuthentication no
Ciphers aes128-ctr,aes192-ctr,aes256-ctr
ClientAliveCountMax 0
ClientAliveInterval 300
Compression delayed
DebianBanner no
PrintMotd no
GatewayPorts no
HostbasedAuthentication no
KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256
IgnoreRhosts yes
MaxAuthTries 2
PermitEmptyPasswords no
PermitRootLogin no
PermitUserEnvironment no
Port $SSHD_PORT
Protocol 2
StrictModes yes
UsePrivilegeSeparation yes
X11Forwarding no
EOF

cat > /etc/ssh/ssh_config << EOF
Host *
    IdentitiesOnly yes
    ForwardAgent no
EOF
```

### Stop the SSH Daemon
```bash
systemctl stop ssh.service
```

### Harden kernel parameters
```bash
cat > /etc/sysctl.d/99-sysctl.conf << EOF
fs.suid_dumpable = 0                                # Restrict core dump files.
kernel.dmesg_restrict=1                             # Prevent unprivileged users from viewing dmesg 
kernel.kptr_restrict=1                              # Prevent access to kernel memory pointers
kernel.randomize_va_space = 2                       # Randomize positions of stack, VDSO, shared memory 
kernel.sysrq = 0                                    # Turn off low-level kernel commands
kernel.yama.ptrace_scope = 2                        # Prevent unprivileged access to ptrace
```

### [Disable Source Based Routing](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/security_guide/sect-security_guide-server_security-disable-source-routing)
```bash
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.all.forwarding = 0
net.ipv4.conf.all.log_martians = 0
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.default.send_redirects = 0
net.ipv4.icmp_echo_ignore_all = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_sack = 0
net.ipv4.tcp_syn_retries = 3
net.ipv4.tcp_synack_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_timestamps = 0
net.ipv4.tcp_tw_reuse = 1
net.ipv6.conf.default.use_tempaddr = 2
EOF
```

### Restrict permissions on key files and reload them into the running kernel
```bash
sed -i 's/^DIR_MODE.*/DIR_MODE=0750/g' /etc/adduser.conf
sed -i 's/^UMASK.*/UMASK\t027/g' /etc/login.defs
echo 'session    optional     pam_umask.so umask=027' >> /etc/pam.d/common-session
echo 'umask 027' >> /root/.bashrc
echo 'umask 027' >> /home/$USERNAME/.bashrc
echo '*   hard    core    0' >> /etc/security/limits.conf
chmod -R 700 /etc/grub.d/* /etc/skel
chmod 600 /etc/sysctl.conf /boot/grub/grub.cfg /etc/crontab
chmod 740 /sbin/iptables
sysctl -p
```

### Update firewall to new SSHD port and enable
```bash
ufw allow $SSHD_PORT
ufw enable
```